# Техническое задание: SecureLog
### Цель:
Разработать веб-приложение для регистрации пользователей, логирования их действий и
демонстрации ключевых возможностей PostgreSQL: функции, триггеры, резервное
копирование, права доступа и безопасность.

---
### Стек:
- Frontend:
  - Vanilla JavaScript (React)
  - Fetch API
- Backend:
  - Fastify
  - PostgreSQL
  - Библиотека `pg`
  - Запуск shell-команд через `child_process` ?
---
### Функционал
Аутентификация
- Регистрация - DONE
  - POST `/api/register` 
  - Передаёт `name`, `email`, `password`
  - Пароль хешируется через `bcrypt`
  - Хеш сохраняется в БД
  - При регистрации вызывается функция `create_user(name, email, password_hash)`
- Логин - TODO
  - POST `/api/login`
  - Принимает `email`, `password`
  - Сравнение с bcrypt-хешем из БД
  - Успешный логин → JWT токен
  - Неуспешный → отказ с 401
- Проверка токена
  - Все приватные маршруты используют middleware проверки JWT
---
### Логирование действий
- Любое действие пользователя (например, изменение имени) записывается в
таблицу logs - DONE
- Используется триггер `AFTER UPDATE` на таблицу users - DONE
- Пример: изменение `email → logs` получает `user_id`, `action`, `timestamp` - DONE
---
### SQL-функции
- `get_user_by_id(id)` — возвращает пользователя - DONE
- `recent_logs(user_id)` — последние 5 действий - DONE
- `search_users(name_pattern)` — поиск по части имени - DONE
- `create_user(...)` — используется при регистрации - DONE
- Все функции вызываются из Fastify-роутов через параметризированные запросы - DONE
---
### Управление правами
- В БД создать двух пользователей:
  - `admin_user` — доступ ко всем операциям - DONE
  - `readonly_user` — только `SELECT` - DONE
- Попробовать подключиться под обоими и сравнить поведение - DONE
- Настроить `GRANT`, `REVOKE`, роли, схемы - DONE
---
### Резервное копирование
- На странице настроек кнопка: **"Сделать бэкап"** - TODO
  - Вызывает скрипт с `pg_dump`, сохраняет файл в `/backups/`
- Кнопка: **"Восстановить БД"** - TODO
  - Загружает `.sql` файл и восстанавливает БД через `psql`
- Бэкапы хранятся с меткой времени - TODO
---
### SQL-инъекции и защита
- Реализовать поиск пользователя по имени `/api/search?name=...` - DONE
- Написать уязвимую версию (для демонстрации) - DONE
- Затем — исправить с параметризацией - DONE
- Подготовить документ с примером атаки и её устранением - TODO
---
### Шифрование / HTTPS
- Сервер Fastify работает по HTTPS (локальный сертификат) - TODO
- Все данные передаются зашифрованно - TODO
- Хранение пароля — только через `bcrypt`
---
### Структура проекта
```
securelog/
├── backend/
│ ├── server.js
│ ├── routes/
│ │ ├── auth.js
│ │ ├── users.js
│ │ └── backup.js
│ ├── db/
│ │ ├── index.js
│ │ ├── functions.sql
│ │ └── triggers.sql
│ └── utils/
│   ├── jwt.js
│   └── shell.js
├── frontend/
│ ├── index.html
│ ├── login.html
│ ├── profile.html
│ └── js/
│   ├── auth.js
│   └── fetch.js
├── backups/
│ └── backup-2025-04-21.sql
└── README.md
```